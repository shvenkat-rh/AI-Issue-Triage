name: Lint

on:
  # Run on pushes to main branch
  push:
    branches:
      - main
      - master
  
  # Run on pull requests
  pull_request:
    branches:
      - main
      - master

jobs:
  black:
    name: Black Code Formatting
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install black
        run: |
          python -m pip install --upgrade pip
          pip install black
      
      - name: Check code formatting with black
        run: |
          black --check --diff --color .
      
      - name: Show black violations (if any)
        if: failure()
        run: |
          echo "::error::Code formatting issues detected. Run 'black .' to fix."
          echo "## âŒ Black Formatting Issues" >> $GITHUB_STEP_SUMMARY
          echo "Run \`black .\` locally to fix formatting issues." >> $GITHUB_STEP_SUMMARY

  isort:
    name: Import Sorting
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install isort
        run: |
          python -m pip install --upgrade pip
          pip install isort
      
      - name: Check import sorting with isort
        run: |
          isort --check-only --diff --color .
      
      - name: Show isort violations (if any)
        if: failure()
        run: |
          echo "::error::Import sorting issues detected. Run 'isort .' to fix."
          echo "## âŒ Import Sorting Issues" >> $GITHUB_STEP_SUMMARY
          echo "Run \`isort .\` locally to fix import sorting issues." >> $GITHUB_STEP_SUMMARY

  flake8:
    name: Flake8 Linting
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install flake8
        run: |
          python -m pip install --upgrade pip
          pip install flake8 flake8-docstrings flake8-bugbear
      
      - name: Lint with flake8 (Critical Errors)
        run: |
          # Stop the build if there are Python syntax errors or undefined names
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
      
      - name: Lint with flake8 (All Issues)
        run: |
          # Report all issues but don't fail the build
          flake8 . --count --max-complexity=10 --max-line-length=127 --statistics \
            --extend-ignore=E203,W503,D100,D101,D102,D103,D104,D105,D106,D107
        continue-on-error: true
      
      - name: Generate flake8 report
        if: always()
        run: |
          echo "## ðŸ” Flake8 Report" >> $GITHUB_STEP_SUMMARY
          flake8 . --count --max-complexity=10 --max-line-length=127 --statistics \
            --extend-ignore=E203,W503,D100,D101,D102,D103,D104,D105,D106,D107 >> $GITHUB_STEP_SUMMARY || true

  summary:
    name: Lint Summary
    runs-on: ubuntu-latest
    needs: [black, isort, flake8]
    if: always()
    
    steps:
      - name: Check lint status
        run: |
          echo "## ðŸ“‹ Lint Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.black.result }}" == "success" ]; then
            echo "âœ… **Black**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Black**: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.isort.result }}" == "success" ]; then
            echo "âœ… **isort**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **isort**: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.flake8.result }}" == "success" ]; then
            echo "âœ… **flake8**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **flake8**: Issues found (non-blocking)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Fix Locally" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Fix formatting" >> $GITHUB_STEP_SUMMARY
          echo "black ." >> $GITHUB_STEP_SUMMARY
          echo "isort ." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Check linting" >> $GITHUB_STEP_SUMMARY
          echo "flake8 ." >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
      
      - name: Set final status
        run: |
          if [ "${{ needs.black.result }}" != "success" ] || [ "${{ needs.isort.result }}" != "success" ]; then
            echo "::error::Code quality checks failed. Please fix formatting issues."
            exit 1
          fi

